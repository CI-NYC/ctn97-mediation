---
title: "README for CTN97 Mediation (with Competing Risks)"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
library(tidyverse)
library(mlr3superlearner)
library(mlr3extralearners)
library(xgboost)
library(earth)
library(checkmate)
library(lcmmtp)
library(knitr)

dat <- readRDS(here::here("data/analysis_data/analysis_data_alt_shift.rds")) |>
  mutate(dose_total_clonazepam_and_benzo_1 = dose_total_clonazepam_1 + dose_total_benzo_1,
         dose_total_clonazepam_and_benzo_2 = dose_total_clonazepam_2 + dose_total_benzo_2,
         dose_total_clonazepam_and_benzo_3 = dose_total_clonazepam_3 + dose_total_benzo_3,
         dose_total_clonazepam_and_benzo_4 = dose_total_clonazepam_4 + dose_total_benzo_4,
         dose_total_clonazepam_and_benzo_5 = dose_total_clonazepam_5 + dose_total_benzo_5
  ) |>
  mutate(
    Arm = ifelse(PROTSEG == 1, "Rapid", "Standard"),
    Group_day_1 = case_when(dose_total_clonidine_1 >= 0.1 & dose_total_clonazepam_and_benzo_1 >= 3 & max_cows_eligible_1 == 1 ~ 3,
                        (dose_total_clonidine_1 >= 0.1 | dose_total_clonazepam_and_benzo_1 >= 2) & max_cows_eligible_1 == 1 ~ 2,
                        (dose_total_clonidine_1 >= 0.1 | dose_total_clonazepam_and_benzo_1 > 0) & max_cows_eligible_1 == 1 ~ 1,
                        TRUE ~ 0),
    Group_day_2 = case_when(is.na(adj_2) ~ as.numeric(NA),
                        dose_total_clonidine_2 >= 0.1 & dose_total_clonazepam_and_benzo_2 >= 3 & max_cows_eligible_2 == 1 ~ 3,
                        (dose_total_clonidine_2 >= 0.1 | dose_total_clonazepam_and_benzo_2 >= 2) & max_cows_eligible_2 == 1 ~ 2,
                        (dose_total_clonidine_2 >= 0.1  | dose_total_clonazepam_and_benzo_2 > 0) & max_cows_eligible_2 == 1 ~ 1,
                        TRUE ~ 0),
    Group_day_3 = case_when(is.na(adj_3) ~ as.numeric(NA),
                        dose_total_clonidine_3 >= 0.1 & dose_total_clonazepam_and_benzo_3 >= 3 & max_cows_eligible_3 == 1 ~ 3,
                        (dose_total_clonidine_3 >= 0.1 | dose_total_clonazepam_and_benzo_3 >= 2) & max_cows_eligible_3 == 1 ~ 2,
                        (dose_total_clonidine_3 >= 0.1 | dose_total_clonazepam_and_benzo_3 > 0) & max_cows_eligible_3 == 1 ~ 1,
                        TRUE ~ 0),
    Group_day_4 = case_when(is.na(adj_4) ~ as.numeric(NA),
                        dose_total_clonidine_4 >= 0.1 & dose_total_clonazepam_and_benzo_4 >= 3 & max_cows_eligible_4 == 1 ~ 3,
                        (dose_total_clonidine_4 >= 0.1 | dose_total_clonazepam_and_benzo_4 >= 2) & max_cows_eligible_4 == 1 ~ 2,
                        (dose_total_clonidine_4 >= 0.1 | dose_total_clonazepam_and_benzo_4 > 0) & max_cows_eligible_4 == 1 ~ 1,
                        TRUE ~ 0),
    Group_day_5 = case_when(is.na(adj_5) ~ as.numeric(NA),
                        dose_total_clonidine_5 >= 0.1 & dose_total_clonazepam_and_benzo_5 >= 3 & max_cows_eligible_5 == 1 ~ 3,
                        (dose_total_clonidine_5 >= 0.1 | dose_total_clonazepam_and_benzo_5 >= 2) & max_cows_eligible_5 == 1 ~ 2,
                        (dose_total_clonidine_5>= 0.1 | dose_total_clonazepam_and_benzo_5 > 0) & max_cows_eligible_5 == 1 ~ 1,
                        TRUE ~ 0)  
  )
```

## Summary

- Using CTN97 data, conduct a longitudinal mediation analysis with competing risks
- Variables of interest:
  - Exposure: randomization arm at baseline (rapid v. standard)
  - Mediator-outcome confounders: maximum COWS score on day t, missing indicator for maximum COWS score on day t $\in$ (1, 2, 3, 4, 5)
    - Previously, we also included an eligibility indicator (1 if eligible to receive additional medication) but we are now including this in the mediator
  - Mediators: adjunctive medication (clonidine, clonazepam, or benzodiazepines) on day t AND eligible for additional medication following max COWS on day t $\in$ (1, 2, 3, 4, 5)
  - Competing event: dropout or initiation of another MOUD on day t $\in$ (5, ..., 14)
  - Outcome: initiation of XR-NTX on day t $\in$ (5, ..., 14)

## Discrete Mediators

- Combine clonazepam and "other" benzodiazepines into a single scale, using common conversion scale [(VA scale)](https://www.healthquality.va.gov/guidelines/MH/sud/VA-DoD-SUD-CPG_Final_for-508_v3.pdf)

- M = 3 indicates that the individual received at least one of clonidine (≥0.1 mg) AND received benzo (≥3 mg) AND was eligible for additional medication (did not receive more than maximum allowable dose in past 24 hours)
- M = 2 indicates that the individual received at least one of clonidine (≥0.1 mg) OR received benzo (≥2 mg) AND was eligible for additional medication (did not receive more than maximum allowable dose in past 24 hours)
- M = 1 indicates that the individual received at least one of clonidine (≥0.1 mg) OR received ANY benzo (>0 mg) AND was eligible for additional medication (did not receive more than maximum allowable dose in past 24 hours)
- M = 0 indicates that the individual did NOT receive at least one of clonidine (≥0.1 mg) or benzo (>0 mg) OR was ineligible for additional medication (received more than maximum allowable dose in past 24 hours)

```{r}
day_1 <- dat |>
  group_by(Arm, Group_day_1) |>
  summarize(count = n()) 

day_2 <- dat |>
  group_by(Arm, Group_day_2) |>
  summarize(count = n()) |>
  filter(is.na(count) == FALSE)

dat |>
  group_by(Arm, Group_day_1) |>
  summarize(count = n()) |>
  kable()

dat |>
  group_by(Arm, Group_day_2) |>
  summarize(count = n()) |>
  kable()

dat |>
  group_by(Arm, Group_day_3) |>
  summarize(count = n()) |>
  kable()


dat |>
  group_by(Arm, Group_day_4) |>
  summarize(count = n()) |>
  kable()

dat |>
  group_by(Arm, Group_day_5) |>
  summarize(count = n()) |>
  kable()
```

## Binary Mediators (old)

### Number of people receiving clonidine (≥0.1 mg), clonazepam (≥1 mg), or other benzo (>0 mg) and eligible for additional medication (did not receive more than maximum allowable dose in past 24 hours), by protocol

#### Table Form

- M = 1 indicates that the individual received at least one of clonidine (≥1 mg), clonazepam (≥0.1 mg), or benzo (>0 mg) AND was eligible for additional medication (did not receive more than maximum allowable dose in past 24 hours)
- M = 0 indicates that the individual did NOT receive at least one of clonidine (≥1 mg), clonazepam (≥0.1 mg), or benzo (>0 mg) OR was ineligible for additional medication (received more than maximum allowable dose in past 24 hours)

```{r}
t1 <- dat |>
  group_by(PROTSEG) |>
  summarize(count = n(),
            M1 = sum(ifelse(adj_1 == 1 & max_cows_eligible_1 == 1, 1, 0)),
            percent = round(M1/n(), 3) * 100)

t2 <- dat |>
  filter(Y_1 == 0,
         C_1 == 1) |>
  group_by(PROTSEG) |>
  summarize(count = n(),
            M2 = sum(ifelse(adj_2 == 1 & max_cows_eligible_2 == 1, 1, 0)),
            percent = round(M2/n(), 3) * 100)

t3 <- dat |>
  filter(Y_2 == 0,
         C_2 == 1) |>
  group_by(PROTSEG) |>
  summarize(count = n(),
            M3 = sum(ifelse(adj_3 == 1 & max_cows_eligible_3 == 1, 1, 0)),
            percent = round(M3/n(), 3) * 100)

t4 <- dat |>
  filter(Y_3 == 0,
         C_3 == 1) |>
  group_by(PROTSEG) |>
  summarize(count = n(),
            M4 = sum(ifelse(adj_4 == 1 & max_cows_eligible_4 == 1, 1, 0)),
            percent = round(M4/n(), 3) * 100)

t5 <- dat |>
  filter(Y_4 == 0,
         C_4 == 1) |>
  group_by(PROTSEG) |>
  summarize(count = n(),
            M5 = sum(ifelse(adj_5 == 1 & max_cows_eligible_5 == 1, 1, 0)),
            percent = round(M5/n(), 3) * 100)
```

<table border="1">
  <tr>
    <th></th>
    <th colspan="2">t = 1</th>
    <th colspan="2">t = 2</th>
    <th colspan="2">t = 3</th>
    <th colspan="2">t = 4</th>
    <th colspan="2">t = 5</th>
  </tr>
  <tr>
    <td>A = 1 (Rapid)</td>
    <td>M = 1, 213 (94.7%)</td>
    <td>M = 0, 12 (5.3%)</td>
    <td>M = 1, 220 (99.1%)</td>
    <td>M = 0, <br>2 (0.9%) </td>
    <td>M = 1, 206 (96.1%)</td>
    <td>M = 0, <br>8 (3.9%)</td>
    <td>M = 1, <br>173 <br>(93.0%)</td>
    <td>M = 0, <br>13 <br>(7.0%)</td>
    <td>M = 1, <br>130 <br>(92.9%)</td>
    <td>M = 0, <br>10 <br>(7.1%)</td>
  </tr>
  <tr>
    <td>A = 0 (Standard)</td>
    <td>M = 1, 119 (62.6%)</td>
    <td>M = 0, 71 (37.4%)</td>
    <td>M = 1, 117 (65.0%)</td>
    <td>M = 0, 63 (35.0%)</td>
    <td>M = 1, 105 (62.1%)</td>
    <td>M = 0, 64 (37.9%) </td>
    <td>M = 1, <br>77 <br>(53.8%)</td>
    <td>M = 0, <br>66 <br>(46.2%)</td>
    <td>M = 1, <br>69 <br>(54.3%)</td>
    <td>M = 0, <br>58 <br>(45.7%)</td>
  </tr>
</table>


#### Plot Form

- Top row of panels shows dosing information for the first 5 days among those who initiated XR-NTX by day 14, stratified by protocol
- Bottom row of panels shows dosing information for the first 5 days among those who did NOT initiate XR-NTX by day 14, stratified by protocol

![Sequence Plot](figures/sequence_plot.png)

Who is getting other benzos? 

- Primarily those in the standard protocol and those who do not experience outcome

#### Table Form (Daily Max COWS)

- M = 1 indicates that the individual received at least one of clonidine (≥1 mg), clonazepam (≥0.1 mg), or benzo (>0 mg) AND was eligible for additional medication (did not receive more than maximum allowable dose in past 24 hours) AND max cows ≥ 3 (and not missing)
- M = 0 indicates that the individual did NOT receive at least one of clonidine (≥1 mg), clonazepam (≥0.1 mg), or benzo (>0 mg) OR was ineligible for additional medication (received more than maximum allowable dose in past 24 hours) OR max cows < 3 (or missing)

```{r}
t1 <- dat |>
  group_by(PROTSEG) |>
  summarize(count = n(),
            M1 = sum(ifelse(adj_1 == 1 & max_cows_eligible_1 == 1 & max_cows_1 >= 3 & max_cows_missing_indicator_1 == 0, 1, 0)),
            percent = round(M1/n(), 3) * 100)

t2 <- dat |>
  filter(Y_1 == 0,
         C_1 == 1) |>
  group_by(PROTSEG) |>
  summarize(count = n(),
            M2 = sum(ifelse(adj_2 == 1 & max_cows_eligible_2 == 1 & max_cows_2 >= 3 & max_cows_missing_indicator_2 == 0, 1, 0)),
            percent = round(M2/n(), 3) * 100)

t3 <- dat |>
  filter(Y_2 == 0,
         C_2 == 1) |>
  group_by(PROTSEG) |>
  summarize(count = n(),
            M3 = sum(ifelse(adj_3 == 1 & max_cows_eligible_3 == 1 & max_cows_3 >= 3 & max_cows_missing_indicator_3 == 0, 1, 0)),
            percent = round(M3/n(), 3) * 100)

t4 <- dat |>
  filter(Y_3 == 0,
         C_3 == 1) |>
  group_by(PROTSEG) |>
  summarize(count = n(),
            M4 = sum(ifelse(adj_4 == 1 & max_cows_eligible_4 == 1 & max_cows_4 >= 3 & max_cows_missing_indicator_4 == 0, 1, 0)),
            percent = round(M4/n(), 3) * 100)

t5 <- dat |>
  filter(Y_4 == 0,
         C_4 == 1) |>
  group_by(PROTSEG) |>
  summarize(count = n(),
            M5 = sum(ifelse(adj_5 == 1 & max_cows_eligible_5 == 1 & max_cows_5 >= 3 & max_cows_missing_indicator_5 == 0, 1, 0)),
            percent = round(M5/n(), 3) * 100)
```

<table border="1">
  <tr>
    <th></th>
    <th colspan="2">t = 1</th>
    <th colspan="2">t = 2</th>
    <th colspan="2">t = 3</th>
    <th colspan="2">t = 4</th>
    <th colspan="2">t = 5</th>
  </tr>
  <tr>
    <td>A = 1 (Rapid)</td>
    <td>M = 1, 179 (79.6%)</td>
    <td>M = 0, 46 (20.4%)</td>
    <td>M = 1, 185 (83.3%)</td>
    <td>M = 0, <br>37 (16.7%) </td>
    <td>M = 1, 176 (85.4%)</td>
    <td>M = 0, <br>30 (14.6%)</td>
    <td>M = 1, <br>136 <br>(73.1%)</td>
    <td>M = 0, <br>50 <br>(26.9%)</td>
    <td>M = 1, <br>96 <br>(68.6%)</td>
    <td>M = 0, <br>44 <br>(31.4%)</td>
  </tr>
  <tr>
    <td>A = 0 (Standard)</td>
    <td>M = 1, 82 (43.2%)</td>
    <td>M = 0, 108 (56.8%)</td>
    <td>M = 1, 85 (47.2%)</td>
    <td>M = 0, 98 (52.8%)</td>
    <td>M = 1, 71 (42.0%)</td>
    <td>M = 0, 98 (58.0%) </td>
    <td>M = 1, <br>50 <br>(35.0%)</td>
    <td>M = 0, <br>93 <br>(65.0%)</td>
    <td>M = 1, <br>40 <br>(31.5%)</td>
    <td>M = 0, <br>87 <br>(68.5%)</td>
  </tr>
</table>
